<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        nav {
            background-color: #34495e;
            padding: 10px;
            text-align: center;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            margin: 0 5px;
            display: inline-block;
        }
        
        nav a:hover {
            background-color: #455a64;
            border-radius: 4px;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        .button {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #2980b9;
        }
        
        .button-secondary {
            background-color: #95a5a6;
        }
        
        .button-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .stat-trend {
            color: #2ecc71;
            font-size: 12px;
        }
        
        .stat-trend.negative {
            color: #e74c3c;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-primary {
            background-color: #3498db;
            color: white;
        }
        
        .badge-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .badge-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .badge-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f8f9fa;
        }
        
        table tr:hover {
            background-color: #f0f4f8;
        }
        
        footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
        }
        
        .refresh-button {
            float: right;
            background-color: transparent;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            color: #3498db;
            font-size: 12px;
        }
        
        .refresh-button:hover {
            background-color: #f0f4f8;
        }
        
        .refresh-button .icon {
            margin-right: 5px;
        }
        
        /* Pie chart container */
        .pie-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .pie-chart {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 20px auto;
        }
        
        .pie-chart-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 10px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 4px;
            margin-right: 5px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 200px;
            }
            
            nav a {
                display: block;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Email Processor Dashboard</h1>
        <p>Process and classify emails from FakeMail</p>
    </header>
    
    <nav>
        <a href="/">Home</a>
        <a href="/dashboard" class="active">Dashboard</a>
        <a href="/emails">Emails</a>
        <a href="/setup">Setup</a>
        <a href="/simulator">FakeMail Simulator</a>
    </nav>
    
    <div class="container">
        <section class="card">
            <button id="refresh-stats" class="refresh-button">
                <span class="icon">🔄</span> Refresh
            </button>
            <h2 class="card-title">System Overview</h2>
            <div class="grid">
                <div class="stat-card">
                    <div class="stat-label">Total Emails Processed</div>
                    <div class="stat-value" id="total-processed">{{ stats.total_emails_processed }}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value" id="success-rate">{{ "%.1f"|format(stats.success_rate) }}%</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Avg. Processing Time</div>
                    <div class="stat-value" id="avg-time">{{ "%.2f"|format(stats.avg_processing_time_ms) }}ms</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Last History ID</div>
                    <div class="stat-value" id="last-history-id">{{ stats.last_history_id }}</div>
                </div>
            </div>
        </section>
        
        <section class="card">
            <div class="tabs">
                <div class="tab active" data-tab="email-types">Email Types</div>
                <div class="tab" data-tab="recent-activity">Recent Activity</div>
                <div class="tab" data-tab="system-health">System Health</div>
            </div>
            
            <div class="tab-content active" id="email-types">
                <h3>Email Classifications</h3>
                <div class="pie-chart-container">
                    <div class="pie-chart" id="classification-chart"></div>
                    <div class="pie-chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3498db;"></div>
                            <div>Intro</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f39c12;"></div>
                            <div>Promotion</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2ecc71;"></div>
                            <div>Meeting</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #95a5a6;"></div>
                            <div>Unknown</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Classification</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="classification-table">
                            {% for classification, count in stats.emails_by_classification.items() %}
                            <tr>
                                <td>{{ classification }}</td>
                                <td>{{ count }}</td>
                                <td>
                                    {% if stats.total_emails_processed > 0 %}
                                        {{ "%.1f"|format(count / stats.total_emails_processed * 100) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="recent-activity">
                <h3>Recent Processing Activity</h3>
                <div class="chart-container">
                    <p>Loading recent activity data...</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table">
                            <tr>
                                <td colspan="4" style="text-align: center;">No recent activity data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="system-health">
                <h3>System Health</h3>
                
                <div class="grid">
                    <div class="stat-card">
                        <div class="stat-label">Redis Status</div>
                        <div class="stat-value" id="redis-status">...</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Processor Status</div>
                        <div class="stat-value" id="processor-status">...</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Uptime</div>
                        <div class="stat-value" id="uptime">...</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Current Workers</div>
                        <div class="stat-value" id="worker-count">...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>System Actions</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="reset-stats-btn" class="button">Reset Statistics</button>
                        <button id="trigger-process-btn" class="button button-success">Trigger Processing</button>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <footer>
        <p>Email Processor - A microservice for processing emails from FakeMail</p>
    </footer>
    
    <script>
        // WebSocket connection
        let socket = null;
        let clientId = 'dashboard-' + Math.random().toString(36).substring(2, 10);
        let socketReconnectTimer = null;
        let lastStats = {{ stats|tojson }};
        let recentEmails = [];
        
        // Initialize WebSocket connection
        function initializeWebSocket() {
            // Close any existing connection
            if (socket) {
                socket.close();
            }
            
            // Create a new WebSocket connection
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsURL = `${wsProtocol}//${window.location.host}/ws/emails/${clientId}`;
            
            socket = new WebSocket(wsURL);
            
            // Connection opened
            socket.addEventListener('open', function(event) {
                console.log('WebSocket connected');
                clearTimeout(socketReconnectTimer);
                
                // Subscribe to email events
                socket.send(JSON.stringify({
                    command: 'subscribe',
                    topic: 'email:all'
                }));
            });
            
            // Listen for messages
            socket.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'email_event') {
                        handleEmailEvent(data);
                    }
                } catch (error) {
                    console.error('Error processing WebSocket message:', error);
                }
            });
            
            // Connection closed
            socket.addEventListener('close', function(event) {
                console.log('WebSocket disconnected');
                
                // Attempt to reconnect after a delay
                socketReconnectTimer = setTimeout(() => {
                    initializeWebSocket();
                }, 5000);
            });
            
            // Connection error
            socket.addEventListener('error', function(event) {
                console.error('WebSocket error:', event);
            });
        }
        
        // Handle email events from WebSocket
        function handleEmailEvent(data) {
            console.log('Email event received:', data);
            
            // Handle different event types
            switch (data.event) {
                case 'new':
                    // Add batch of new emails to recent activity
                    if (data.data.sample_emails) {
                        data.data.sample_emails.forEach(email => {
                            recentEmails.unshift(email);
                        });
                        
                        // Keep only the latest 20 emails
                        if (recentEmails.length > 20) {
                            recentEmails.splice(20);
                        }
                        
                        // Update recent activity table
                        updateRecentActivity();
                    }
                    break;
                    
                case 'process':
                    // Add processed email to recent activity
                    recentEmails.unshift(data.data);
                    
                    // Keep only the latest 20 emails
                    if (recentEmails.length > 20) {
                        recentEmails.pop();
                    }
                    
                    // Update recent activity table
                    updateRecentActivity();
                    
                    // Wait briefly then request stats to reflect the new processing
                    setTimeout(() => {
                        // Request latest stats
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({
                                command: 'fetch_stats'
                            }));
                        }
                    }, 500);
                    break;
                    
                case 'stats':
                    // Update dashboard with new stats
                    console.log('Received stats update:', data.data);
                    updateDashboardStats(data.data);
                    break;
                    
                default:
                    console.log('Unknown event type:', data.event);
            }
        }
        
        // Fetch the latest stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) throw new Error('Failed to fetch stats');
                
                const stats = await response.json();
                lastStats = stats;
                
                // Update the dashboard stats
                updateDashboardStats(stats);
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        // Update the dashboard with the latest stats
        function updateDashboardStats(stats) {
            // Update main stats
            document.getElementById('total-processed').textContent = stats.total_emails_processed;
            document.getElementById('success-rate').textContent = `${stats.success_rate.toFixed(1)}%`;
            document.getElementById('avg-time').textContent = `${stats.avg_processing_time_ms.toFixed(2)}ms`;
            document.getElementById('last-history-id').textContent = stats.last_history_id;
            
            // Update classification table
            const tableBody = document.getElementById('classification-table');
            tableBody.innerHTML = '';
            
            for (const [classification, count] of Object.entries(stats.emails_by_classification)) {
                const percentage = stats.total_emails_processed > 0 
                    ? (count / stats.total_emails_processed * 100).toFixed(1) 
                    : '0';
                    
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${classification}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                `;
                tableBody.appendChild(row);
            }
            
            // Update pie chart
            createPieChart();
        }
        
        // Update recent activity table
        function updateRecentActivity() {
            const tableBody = document.getElementById('activity-table');
            tableBody.innerHTML = '';
            
            if (recentEmails.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align: center;">No recent activity data available</td>';
                tableBody.appendChild(row);
                return;
            }
            
            for (const email of recentEmails) {
                const row = document.createElement('tr');
                
                // Format date
                const time = email.processed_at 
                    ? new Date(email.processed_at).toLocaleTimeString() 
                    : new Date().toLocaleTimeString();
                
                // Determine status badge
                let statusBadge = '';
                if (email.status === 'completed') {
                    statusBadge = '<span class="badge badge-success">Completed</span>';
                } else if (email.status === 'processing') {
                    statusBadge = '<span class="badge badge-warning">Processing</span>';
                } else if (email.status === 'failed') {
                    statusBadge = '<span class="badge badge-danger">Failed</span>';
                }
                
                // Create row
                row.innerHTML = `
                    <td>${time}</td>
                    <td>Process Email</td>
                    <td>${statusBadge || email.classification || 'Unknown'}</td>
                    <td>Email ID: ${email.email_id} ${email.subject ? `<br>Subject: ${email.subject}` : ''}</td>
                `;
                tableBody.appendChild(row);
            }
        }
        
        // Start periodic stats refresh (as a backup to realtime updates)
        let statsRefreshInterval = null;
        function startPeriodicRefresh() {
            // Clear any existing interval
            if (statsRefreshInterval) {
                clearInterval(statsRefreshInterval);
            }
            
            // Fetch stats initially
            fetchStats();
            
            // Set up interval for periodic refresh (every 30 seconds)
            statsRefreshInterval = setInterval(fetchStats, 30000);
        }
        
        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Function to load health status
        async function loadHealthStatus() {
            try {
                const response = await fetch('/health');
                if (!response.ok) throw new Error('Failed to load health status');
                
                const data = await response.json();
                
                // Update Redis status
                document.getElementById('redis-status').textContent = data.components.redis;
                if (data.components.redis === 'connected') {
                    document.getElementById('redis-status').style.color = '#2ecc71';
                } else {
                    document.getElementById('redis-status').style.color = '#e74c3c';
                }
                
                // Update processor status
                document.getElementById('processor-status').textContent = data.components.processor;
                if (data.components.processor === 'running') {
                    document.getElementById('processor-status').style.color = '#2ecc71';
                } else {
                    document.getElementById('processor-status').style.color = '#e74c3c';
                }
                
                // Update uptime
                const uptime = data.metrics.uptime_seconds;
                let uptimeText = '';
                
                if (uptime < 60) {
                    uptimeText = `${uptime} seconds`;
                } else if (uptime < 3600) {
                    uptimeText = `${Math.floor(uptime / 60)} minutes`;
                } else if (uptime < 86400) {
                    uptimeText = `${Math.floor(uptime / 3600)} hours`;
                } else {
                    uptimeText = `${Math.floor(uptime / 86400)} days`;
                }
                
                document.getElementById('uptime').textContent = uptimeText;
            } catch (error) {
                console.error('Error loading health status:', error);
                document.getElementById('redis-status').textContent = 'Error';
                document.getElementById('processor-status').textContent = 'Error';
                document.getElementById('uptime').textContent = 'Error';
            }
        }
        
        // Function to load worker info
        async function loadWorkerInfo() {
            try {
                const response = await fetch('/workers');
                if (!response.ok) throw new Error('Failed to load worker info');
                
                const data = await response.json();
                
                // Update worker count
                const workers = data.workers || {};
                const workerCount = Object.keys(workers).length;
                
                document.getElementById('worker-count').textContent = workerCount;
            } catch (error) {
                console.error('Error loading worker info:', error);
                document.getElementById('worker-count').textContent = 'Error';
            }
        }
        
        // Function to create a basic pie chart
        function createPieChart() {
            const classifications = {{ stats.emails_by_classification|tojson }};
            const total = {{ stats.total_emails_processed }};
            
            if (total === 0) {
                document.getElementById('classification-chart').innerHTML = 
                    '<div style="text-align: center; padding: 50px;">No data available</div>';
                return;
            }
            
            // Define colors for each classification
            const colors = {
                'intro': '#3498db',
                'promotion': '#f39c12',
                'meeting': '#2ecc71',
                'unknown': '#95a5a6'
            };
            
            // Create the SVG element
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('viewBox', '0 0 100 100');
            
            // Calculate each slice
            let startAngle = 0;
            for (const [classification, count] of Object.entries(classifications)) {
                if (count === 0) continue;
                
                const percentage = count / total;
                const endAngle = startAngle + percentage * 360;
                
                // Create slice
                const slice = createSlice(50, 50, 50, startAngle, endAngle, colors[classification] || '#95a5a6');
                svg.appendChild(slice);
                
                startAngle = endAngle;
            }
            
            // Add to the chart
            document.getElementById('classification-chart').innerHTML = '';
            document.getElementById('classification-chart').appendChild(svg);
        }
        
        // Helper function to create a pie slice
        function createSlice(cx, cy, r, startAngle, endAngle, color) {
            // Convert angles to radians
            const startRad = (startAngle - 90) * Math.PI / 180;
            const endRad = (endAngle - 90) * Math.PI / 180;
            
            // Calculate points
            const x1 = cx + r * Math.cos(startRad);
            const y1 = cy + r * Math.sin(startRad);
            const x2 = cx + r * Math.cos(endRad);
            const y2 = cy + r * Math.sin(endRad);
            
            // Create path element
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            // Determine if the slice is a full circle
            const largeArc = endAngle - startAngle > 180 ? 1 : 0;
            
            // Create path
            const d = `M ${cx},${cy} L ${x1},${y1} A ${r},${r} 0 ${largeArc},1 ${x2},${y2} Z`;
            
            path.setAttribute('d', d);
            path.setAttribute('fill', color);
            
            return path;
        }
        
        // Refresh stats button
        document.getElementById('refresh-stats').addEventListener('click', () => {
            // Don't reload the page, just fetch new data
            fetchStats();
            loadHealthStatus();
            loadWorkerInfo();
            
            // Update UI to show refresh is happening
            const refreshBtn = document.getElementById('refresh-stats');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="icon">⏳</span> Refreshing...';
            refreshBtn.disabled = true;
            
            // Re-enable after a short delay
            setTimeout(() => {
                refreshBtn.innerHTML = originalContent;
                refreshBtn.disabled = false;
            }, 1000);
        });
        
        // Reset stats button
        document.getElementById('reset-stats-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to reset all statistics?')) {
                return;
            }
            
            try {
                const response = await fetch('/system/reset-stats', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to reset statistics');
                
                alert('Statistics have been reset successfully.');
                fetchStats(); // Just fetch new stats instead of reloading
            } catch (error) {
                console.error('Error resetting stats:', error);
                alert('Failed to reset statistics. Please try again.');
            }
        });
        
        // Trigger processing button
        document.getElementById('trigger-process-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/process/trigger', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to trigger processing');
                
                // Update UI to show success
                const btn = document.getElementById('trigger-process-btn');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '✅ Processing triggered!';
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                }, 2000);
            } catch (error) {
                console.error('Error triggering processing:', error);
                alert('Failed to trigger processing. Please try again.');
            }
        });
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize WebSocket
            initializeWebSocket();
            
            // Load initial data
            loadHealthStatus();
            loadWorkerInfo();
            createPieChart();
            
            // Start periodic refresh as backup
            startPeriodicRefresh();
        });
    </script>
</body>
</html>